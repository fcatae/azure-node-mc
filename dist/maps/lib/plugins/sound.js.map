{"version":3,"sources":["lib/plugins/sound.js"],"names":[],"mappings":"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","file":"lib/plugins/sound.js","sourcesContent":["const Vec3 = require('vec3').Vec3;\n\nmodule.exports.server=function(serv) {\n  serv.playSound = (sound, world, position, {whitelist,blacklist=[],radius=32*32,volume=1.0,pitch=1.0}={}) => {\n    const players = (typeof whitelist != 'undefined' ? (typeof whitelist instanceof Array ? whitelist : [whitelist]) : serv.getNearby({\n      world: world,\n      position: position.scaled(32).floored(),\n      radius: radius // 32 blocks, fixed position\n    }));\n    players.filter(player => blacklist.indexOf(player) == -1)\n      .forEach(player => {\n        const pos = (position || player.position.scaled(1/32)).scaled(8).floored();\n        player._client.write('named_sound_effect', {\n          soundName: sound,\n          x: pos.x,\n          y: pos.y,\n          z: pos.z,\n          volume: volume,\n          pitch: Math.round(pitch*63)\n        });\n      });\n  };\n\n  serv.playNoteBlock = (pitch, world, position, {instrument='harp', particle=true}={}) => {\n    if (particle) {\n      serv.emitParticle(23, world, position.clone().add(new Vec3(0.5, 1.5, 0.5)), {\n        count: 1,\n       size: new Vec3(0, 0, 0)\n      });\n    }\n    serv.playSound('note.' + instrument, world, position, { pitch: serv.getNote(pitch) });\n  };\n\n  serv.getNote = note => 0.5 * Math.pow(Math.pow(2, 1/12), note);\n};\n\nmodule.exports.player=function(player,serv) {\n  player.playSound = (sound, opt={}) => {\n    opt.whitelist = player;\n    serv.playSound(sound, player.world, null, opt);\n  };\n\n  player.on('placeBlock_cancel', async ({reference}, cancel) => {\n    if (player.crouching) return;\n    const id = await player.world.getBlockType(reference);\n    if (id != 25) return;\n    cancel(false);\n    if (!player.world.blockEntityData[reference.toString()]) player.world.blockEntityData[reference.toString()] = {};\n    const data = player.world.blockEntityData[reference.toString()];\n    if (typeof data.note == 'undefined') data.note = -1;\n    data.note++;\n    data.note %= 25;\n    serv.playNoteBlock(data.note, player.world, reference);\n  });\n\n  player.on('dig_cancel', async ({position}, cancel) => {\n    const id = await player.world.getBlockType(position);\n    if (id != 25) return;\n    cancel(false);\n    if (!player.world.blockEntityData[position.toString()]) player.world.blockEntityData[position.toString()] = {};\n    const data = player.world.blockEntityData[position.toString()];\n    if (typeof data.note == 'undefined') data.note = 0;\n    serv.playNoteBlock(data.note ,player.world, position);\n  });\n\n\n  player.commands.add({\n    base: 'playsound',\n    info: 'to play sound for yourself',\n    usage: '/playsound <sound_name> [volume] [pitch]',\n    op: true,\n    parse(str) {\n      const results=str.match(/([^ ]+)(?: ([^ ]+))?(?: ([^ ]+))?/);\n      if(!results) return false;\n      return {\n        sound_name:results[1],\n        volume:results[2] ? parseFloat(results[2]) : 1.0,\n        pitch:results[3] ? parseFloat(results[3]) : 1.0\n      };\n    },\n    action({sound_name,volume,pitch}) {\n      player.chat('Playing \"'+sound_name+'\" (volume: ' + volume + ', pitch: ' + pitch + ')');\n      player.playSound(sound_name, {volume: volume,pitch: pitch});\n    }\n  });\n\n  player.commands.add({\n    base: 'playsoundforall',\n    info: 'to play sound for everyone',\n    usage: '/playsoundforall <sound_name> [volume] [pitch]',\n    op: true,\n    parse(str) {\n      const results=str.match(/([^ ]+)(?: ([^ ]+))?(?: ([^ ]+))?/);\n      if(!results) return false;\n      return {\n        sound_name:results[1],\n        volume:results[2] ? parseFloat(results[2]) : 1.0,\n        pitch:results[3] ? parseFloat(results[3]) : 1.0\n      };\n    },\n    action({sound_name,volume,pitch}) {\n      player.chat('Playing \"'+sound_name+'\" (volume: ' + volume + ', pitch: ' + pitch + ')');\n      serv.playSound(sound_name, player.world, player.position.scaled(1/32), {volume: volume,pitch: pitch});\n    }\n  });\n};\n\nmodule.exports.entity=function(entity,serv) {\n  entity.playSoundAtSelf = (sound, opt={}) => {\n    serv.playSound(sound, entity.world, entity.position.scaled(1/32), opt);\n  }\n};"],"sourceRoot":"/source/"}