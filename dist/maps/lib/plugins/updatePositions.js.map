{"version":3,"sources":["lib/plugins/updatePositions.js"],"names":[],"mappings":";;;;;;AAAA,IAAM,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC;;AAElC,IAAI,CAAC,SAAS,CAAC,eAAe,GAAC,YAAW;AACxC,SAAO,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,OAAO,EAAE,CAAC;CAClC,CAAC;;AAEF,MAAM,CAAC,OAAO,CAAC,MAAM,GAAC,UAAS,MAAM,EACrC;;;AACE,QAAM,CAAC,OAAO,CAAC,EAAE,CAAC,MAAM,EAAE;qEAAwB,EAAE;;QAAxB,GAAG,QAAH,GAAG;QAAC,KAAK,QAAL,KAAK;QAAC,QAAQ,QAAR,QAAQ;WAAW,QAAQ,CAAC,GAAG,EAAC,KAAK,EAAC,QAAQ,CAAC;GAAA,CAAC,CAAC;;;AAGvF,WAAS,IAAI,CAAC,CAAC,EAAC;AACd,QAAI,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,AAAC,CAAC,GAAG,GAAG,GAAI,GAAG,GAAG,GAAG,CAAC,CAAC;AAC1C,QAAI,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,IAAI,GAAG,CAAC,KAClB,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC,IAAI,GAAG,CAAC;AAC3B,WAAO,CAAC,CAAC;GACV;AACD,WAAS,QAAQ,CAAC,GAAG,EAAC,KAAK,EAAC,QAAQ,EACpC;AACE,UAAM,CAAC,QAAQ,CAAC,MAAM,EAAE;AACtB,SAAG,EAAE,GAAG;AACR,WAAK,EAAE,KAAK;AACZ,cAAQ,EAAE,QAAQ;KACnB,EAAE,YAAM;AACP,UAAM,OAAO,GAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACxB,UAAM,SAAS,GAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AAC5B,UAAI,OAAO,IAAI,MAAM,CAAC,GAAG,IAAI,SAAS,IAAI,MAAM,CAAC,KAAK,EAAE,OAAO;AAC/D,YAAM,CAAC,kBAAkB,CAAC,aAAa,EAAE;AACvC,gBAAQ,EAAE,MAAM,CAAC,EAAE;AACnB,WAAG,EAAE,OAAO;AACZ,aAAK,EAAE,SAAS;AAChB,gBAAQ,EAAE,QAAQ;OACnB,CAAC,CAAC;AACH,YAAM,CAAC,GAAG,GAAG,OAAO,CAAC;AACrB,YAAM,CAAC,KAAK,GAAG,SAAS,CAAC;AACzB,YAAM,CAAC,QAAQ,GAAG,QAAQ,CAAC;AAC3B,YAAM,CAAC,kBAAkB,CAAC,sBAAsB,EAAE;AAChD,gBAAQ,EAAE,MAAM,CAAC,EAAE;AACnB,eAAO,EAAE,OAAO;OACjB,CAAC,CAAC;KACJ,EAAE,YAAM;AACP,YAAM,CAAC,gBAAgB,EAAE,CAAC;KAC3B,CAAC,CAAC;GACJ;;AAED,QAAM,CAAC,OAAO,CAAC,EAAE,CAAC,UAAU,EAAE,YAA2B;sEAAP,EAAE;;QAApB,CAAC,SAAD,CAAC;QAAC,CAAC,SAAD,CAAC;QAAC,CAAC,SAAD,CAAC;QAAC,QAAQ,SAAR,QAAQ;;AAC5C,UAAM,CAAC,YAAY,CAAC,AAAC,IAAI,IAAI,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAE,eAAe,EAAE,EAAE,QAAQ,CAAC,CAAC;GACtE,CAAC,CAAC;;AAEH,QAAM,CAAC,OAAO,CAAC,EAAE,CAAC,eAAe,EAAE,YAAqC;sEAAP,EAAE;;QAA9B,CAAC,SAAD,CAAC;QAAC,CAAC,SAAD,CAAC;QAAC,CAAC,SAAD,CAAC;QAAC,QAAQ,SAAR,QAAQ;QAAC,GAAG,SAAH,GAAG;QAAC,KAAK,SAAL,KAAK;;AAC3D,UAAM,CAAC,YAAY,CAAC,AAAC,IAAI,IAAI,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAE,eAAe,EAAE,EAAE,QAAQ,CAAC,CAAC;AACrE,YAAQ,CAAC,GAAG,EAAC,KAAK,EAAC,QAAQ,CAAC,CAAC;GAC9B,CAAC,CAAC;;AAEH,QAAM,CAAC,gBAAgB,GAAG,YAAM;AAC9B,UAAM,CAAC,OAAO,CAAC,KAAK,CAAC,UAAU,EAAE;AAC/B,OAAC,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC,GAAC,EAAE;AACvB,OAAC,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC,GAAC,EAAE;AACvB,OAAC,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC,GAAC,EAAE;AACvB,SAAG,EAAE,MAAM,CAAC,GAAG;AACf,WAAK,EAAE,MAAM,CAAC,KAAK;AACnB,WAAK,EAAE,IAAI;KACZ,CAAC,CAAC;GACJ,CAAC;;AAEF,QAAM,CAAC,QAAQ,GAAG,oBAAO,QAAQ;QACzB,YAAY;;;;;2CAAS,MAAM,CAAC,YAAY,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,OAAO,EAAE,EAAE,KAAK,EAAE,IAAI,CAAC;;;AAApF,sBAAY;;AAClB,cAAI,YAAY,EAAE,MAAM,CAAC,gBAAgB,EAAE,CAAC;;;;;;;GAC7C,CAAC;;AAEF,QAAM,CAAC,aAAa,GAAG,YAAM;;AAC3B,QAAM,OAAO,GAAG,MAAM,CAAC,QAAQ,IAAI,CAAC,IAAI,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAC;AAC7D,QAAM,MAAM,GAAG,MAAM,CAAC,QAAQ,IAAI,CAAC,IAAI,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAC;AAC5D,QAAM,QAAQ,GAAG,CAAC,MAAM,CAAC,QAAQ,IAAI,MAAM,CAAC;AAC5C,QAAM,YAAY,GAAG,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAC;AAC1C,QAAM,CAAC,GAAG,AAAC,CAAC,OAAO,GAAC,CAAC,GAAK,CAAC,MAAM,GAAC,CAAC,AAAC,GAAI,CAAC,QAAQ,GAAC,CAAC,AAAC,GAAI,CAAC,YAAY,AAAC,CAAC;AACvE,QAAM,YAAY,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,IAAI,GAAI,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,SAAS,GAAG,CAAC,GAAI,CAAC,CAAA,GAAI,GAAG,CAAA,AAAC,CAAC;AAC3G,QAAM,WAAW,GAAG,GAAG,CAAC;;;;;;;GAOzB,CAAA;CACF,CAAC;;AAEF,MAAM,CAAC,OAAO,CAAC,MAAM,GAAC,UAAS,MAAM,EAAC;AACpC,QAAM,CAAC,YAAY,GAAG,UAAC,QAAQ,EAAE,QAAQ,EAAqB;QAAnB,QAAQ,yDAAC,KAAK;;AACvD,QAAI,OAAO,QAAQ,IAAI,WAAW,EAAE,MAAM,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC;AAC7D,QAAI,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,MAAM,CAAC,QAAQ,IAAI,QAAQ,EAAE,OAAO,SAAQ,OAAO,EAAE,CAAC;AAC9F,WAAO,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE;AAC7B,cAAQ,EAAE,QAAQ;AAClB,cAAQ,EAAE,QAAQ;AAClB,cAAQ,EAAE,QAAQ;KACnB,EAAE,UAAC,KAAmB,EAAK;UAAvB,QAAQ,GAAT,KAAmB,CAAlB,QAAQ;UAAC,QAAQ,GAAlB,KAAmB,CAAT,QAAQ;;AACpB,UAAM,IAAI,GAAG,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;AAC7C,UAAG,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,GAAC,GAAG,IAAI,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,GAAC,GAAG,IAAI,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,GAAC,GAAG,EACzD,MAAM,CAAC,kBAAkB,CAAC,iBAAiB,EAAE;AAC3C,gBAAQ,EAAE,MAAM,CAAC,EAAE;AACnB,SAAC,EAAE,QAAQ,CAAC,CAAC;AACb,SAAC,EAAE,QAAQ,CAAC,CAAC;AACb,SAAC,EAAE,QAAQ,CAAC,CAAC;AACb,WAAG,EAAE,MAAM,CAAC,GAAG;AACf,aAAK,EAAE,MAAM,CAAC,KAAK;AACnB,gBAAQ,EAAE,QAAQ;OACnB,CAAC,CAAC,KACA,IAAI,IAAI,CAAC,UAAU,CAAC,IAAI,IAAI,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,EAAE,MAAM,CAAC,kBAAkB,CAAC,iBAAiB,EAAE;AAC7F,gBAAQ,EAAE,MAAM,CAAC,EAAE;AACnB,UAAE,EAAE,IAAI,CAAC,CAAC;AACV,UAAE,EAAE,IAAI,CAAC,CAAC;AACV,UAAE,EAAE,IAAI,CAAC,CAAC;AACV,gBAAQ,EAAE,QAAQ;OACnB,CAAC,CAAC;;AAEH,YAAM,CAAC,QAAQ,GAAG,QAAQ,CAAC;AAC3B,YAAM,CAAC,QAAQ,GAAG,QAAQ,CAAC;KAC5B,EAAE,YAAM;AACP,UAAI,MAAM,CAAC,IAAI,IAAI,QAAQ,EAAE,MAAM,CAAC,gBAAgB,EAAE,CAAC;KACxD,CAAC,CAAC;GACJ,CAAC;;AAEF,QAAM,CAAC,QAAQ,GAAG,UAAC,GAAG,EAAK;;AACzB,UAAM,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;GAClD,CAAA;CACF,CAAC","file":"lib/plugins/updatePositions.js","sourcesContent":["const Vec3 = require(\"vec3\").Vec3;\n\nVec3.prototype.toFixedPosition=function() {\n  return this.scaled(32).floored();\n};\n\nmodule.exports.player=function(player)\n{\n  player._client.on('look', ({yaw,pitch,onGround} = {}) => sendLook(yaw,pitch,onGround));\n\n  // float (degrees) --> byte (1/256 \"degrees\")\n  function conv(f){\n    let b = Math.floor((f % 360) * 256 / 360);\n    if (b < -128) b += 256;\n    else if (b > 127) b -= 256;\n    return b;\n  }\n  function sendLook(yaw,pitch,onGround)\n  {\n    player.behavior('look', {\n      yaw: yaw,\n      pitch: pitch,\n      onGround: onGround\n    }, () => {\n      const convYaw=conv(yaw);\n      const convPitch=conv(pitch);\n      if (convYaw == player.yaw && convPitch == player.pitch) return;\n      player._writeOthersNearby(\"entity_look\", {\n        entityId: player.id,\n        yaw: convYaw,\n        pitch: convPitch,\n        onGround: onGround\n      });\n      player.yaw = convYaw;\n      player.pitch = convPitch;\n      player.onGround = onGround;\n      player._writeOthersNearby(\"entity_head_rotation\", {\n        entityId: player.id,\n        headYaw: convYaw\n      });\n    }, () => {\n      player.sendSelfPosition();\n    });\n  }\n\n  player._client.on('position', ({x,y,z,onGround} = {}) => {\n    player.sendPosition((new Vec3(x, y, z)).toFixedPosition(), onGround);\n  });\n\n  player._client.on('position_look', ({x,y,z,onGround,yaw,pitch} = {}) => {\n    player.sendPosition((new Vec3(x, y, z)).toFixedPosition(), onGround);\n    sendLook(yaw,pitch,onGround);\n  });\n\n  player.sendSelfPosition = () => {\n    player._client.write('position', {\n      x: player.position.x/32,\n      y: player.position.y/32,\n      z: player.position.z/32,\n      yaw: player.yaw,\n      pitch: player.pitch,\n      flags: 0x00\n    });\n  };\n\n  player.teleport = async (position) => {\n    const notCancelled = await player.sendPosition(position.scaled(32).floored(), false, true);\n    if (notCancelled) player.sendSelfPosition();\n  };\n\n  player.sendAbilities = () => { // TODO: Fix all of this...\n    const godmode = player.gameMode == 1 || player.gameMode == 3;\n    const canFly = player.gameMode == 1 || player.gameMode == 3;\n    const isFlying = !player.onGround && canFly;\n    const creativeMode = player.gameMode == 1;\n    const f = (+godmode*8) + (+canFly*4) + (+isFlying*2) + (+creativeMode);\n    const walkingSpeed = 0.2 * (1 + (player.effects[1] != null ? (player.effects[1].amplifier + 1) : 0) * 0.2);\n    const flyingSpeed = 0.1;\n    /*console.log(walkingSpeed, flyingSpeed);\n    player._client.write('abilities', { // FIIIIXXXXXXX\n      flags: f,\n      walkingSpeed: walkingSpeed,\n      flyingSpeed: flyingSpeed\n    });*/ \n  }\n};\n\nmodule.exports.entity=function(entity){\n  entity.sendPosition = (position, onGround, teleport=false) => {\n    if (typeof position == 'undefined') throw new Error('undef');\n    if (entity.position.equals(position) && entity.onGround == onGround) return Promise.resolve();\n    return entity.behavior('move', {\n      position: position,\n      onGround: onGround,\n      teleport: teleport\n    }, ({position,onGround}) => {\n      const diff = position.minus(entity.position);\n      if(diff.abs().x>127 || diff.abs().y>127 || diff.abs().z>127)\n        entity._writeOthersNearby('entity_teleport', {\n          entityId: entity.id,\n          x: position.x,\n          y: position.y,\n          z: position.z,\n          yaw: entity.yaw,\n          pitch: entity.pitch,\n          onGround: onGround\n        });\n      else if (diff.distanceTo(new Vec3(0, 0, 0)) != 0) entity._writeOthersNearby('rel_entity_move', {\n        entityId: entity.id,\n        dX: diff.x,\n        dY: diff.y,\n        dZ: diff.z,\n        onGround: onGround\n      });\n\n      entity.position = position;\n      entity.onGround = onGround;\n    }, () => {\n      if (entity.type == 'player') player.sendSelfPosition();\n    });\n  };\n\n  entity.teleport = (pos) => { // Overwritten in players inject above\n    entity.sendPosition(pos.scaled(32), false, true);\n  }\n};\n"],"sourceRoot":"/source/"}