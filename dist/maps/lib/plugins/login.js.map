{"version":3,"sources":["lib/plugins/login.js"],"names":[],"mappings":";;;;;;;;AAAA,IAAM,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC;;AAElC,IAAM,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC7B,IAAM,YAAY,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC;AAC7C,IAAM,OAAO,GAAG,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,EAAC,IAAI,EAAE,SAAS,CAAC,CAAC,CAAC;AACnE,IAAM,OAAO,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC,OAAO,CAAC;;AAEhD,MAAM,CAAC,OAAO,CAAC,MAAM,GAAC,UAAS,IAAI,EAAC,OAAO,EAC3C;;;AACE,MAAI,CAAC,OAAO,CAAC,EAAE,CAAC,YAAY,EAAE,UAAA,MAAM;WAClC,MAAM,CAAC,EAAE,CAAC,OAAO,EAAC,UAAA,KAAK;aAAI,IAAI,CAAC,IAAI,CAAC,aAAa,EAAC,MAAM,EAAC,KAAK,CAAC;KAAA,CAAC;GAAA,CAAC,CAAC;;AAErE,MAAI,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,EAAE,oBAAO,MAAM;;;;;;gBACjC,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,MAAM,IAAE,CAAC,CAAA;;;;;;;;;;;gBAEnC,MAAM;;;;AAAN,wBAAM,GAAG,IAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,IAAI,EAAE,IAAI,CAAC,SAAS,EAAE,IAAI,IAAI,CAAC,CAAC,EAAC,CAAC,EAAC,CAAC,CAAC,CAAC;;AAC/E,wBAAM,CAAC,OAAO,GAAC,MAAM,CAAC;;AAEtB,wBAAM,CAAC,iBAAiB,GAAC,MAAM,CAAC,OAAO,CAAC,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,UAAU,GAAG,EAAE,CAAC;AACzF,wBAAM,CAAC,QAAQ,GAAG,IAAI,OAAO,CAAC,EAAE,CAAC,CAAC;AAClC,+BAAY,OAAO,CAAC,CACjB,MAAM,CAAC,UAAA,UAAU;2BAAI,OAAO,CAAC,UAAU,CAAC,CAAC,MAAM,IAAE,SAAS;mBAAA,CAAC,CAC3D,OAAO,CAAC,UAAA,UAAU;2BAAI,OAAO,CAAC,UAAU,CAAC,CAAC,MAAM,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,CAAC;mBAAA,CAAC,CAAC;;AAE5E,sBAAI,CAAC,IAAI,CAAC,WAAW,EAAC,MAAM,CAAC,CAAC;AAC9B,wBAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;;mDACd,MAAM,CAAC,KAAK,EAAE;;;;;;;;;;;;;;;;;AAGpB,oBAAU,CAAC,YAAM;AAAC,iCAAU;WAAC,EAAC,CAAC,CAAC,CAAA;;;;;;;GAEnC,CAAC,CAAC;CACJ,CAAC;;AAEF,MAAM,CAAC,OAAO,CAAC,MAAM,GAAC,UAAS,MAAM,EAAC,IAAI,EAAC,QAAQ,EACnD;;;AACE,WAAS,SAAS,GAClB;AACE,UAAM,CAAC,IAAI,GAAG,QAAQ,CAAC;AACvB,UAAM,CAAC,MAAM,GAAG,EAAE,CAAC;AACnB,UAAM,CAAC,IAAI,GAAG,EAAE,CAAC;AACjB,UAAM,CAAC,SAAS,GAAG,KAAK,CAAC;AACzB,UAAM,CAAC,EAAE,GAAG,QAAQ,CAAC,cAAc,CAAC,CAAC;AACrC,UAAM,CAAC,QAAQ,GAAC,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC;AACxC,QAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AAC1B,QAAI,CAAC,YAAY,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,MAAM,CAAC;AAChD,UAAM,CAAC,YAAY,GAAC,EAAE,CAAC;AACvB,UAAM,CAAC,YAAY,GAAC,EAAE,CAAC;GACxB;;AAED,WAAS,SAAS,GAClB;;AAEE,UAAM,CAAC,OAAO,CAAC,KAAK,CAAC,OAAO,EAAE;AAC5B,cAAQ,EAAE,MAAM,CAAC,EAAE;AACnB,eAAS,EAAE,SAAS;AACpB,cAAQ,EAAE,MAAM,CAAC,QAAQ;AACzB,eAAS,EAAE,CAAC;AACZ,gBAAU,EAAE,CAAC;AACb,sBAAgB,EAAE,KAAK;AACvB,gBAAU,EAAE,IAAI,CAAC,OAAO,CAAC,UAAU;KACpC,CAAC,CAAC;AACH,UAAM,CAAC,QAAQ,GAAC,MAAM,CAAC,UAAU,CAAC,eAAe,EAAE,CAAC;GACrD;;AAED,WAAS,iBAAiB,GAC1B;AACE,UAAM,CAAC,EAAE,CAAC,MAAM,EAAE,YAAM;AACtB,UAAG,CAAC,MAAM,CAAC,aAAa,IAAI,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,MAAM,CAAC,wBAAwB,CAAC,GAAC,EAAE,GAAC,EAAE,EAC3F,MAAM,CAAC,WAAW,EAAE,CAAC;KACxB,CAAC,CAAC;GACJ;;AAED,WAAS,UAAU,GACnB;AACE,UAAM,CAAC,OAAO,CAAC,KAAK,CAAC,aAAa,EAAE;AAClC,SAAG,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;AACX,UAAI,EAAE,CAAC,CAAC,EAAE,IAAI,CAAC,IAAI,CAAC;KACrB,CAAC,CAAC;GACJ;;AAED,QAAM,CAAC,WAAW,GAAG,UAAA,QAAQ,EAC7B;AACE,UAAM,CAAC,QAAQ,GAAC,QAAQ,CAAC;AACzB,UAAM,CAAC,OAAO,CAAC,KAAK,CAAC,mBAAmB,EAAE;AACxC,YAAM,EAAE,CAAC;AACT,cAAQ,EAAE,MAAM,CAAC,QAAQ;KAC1B,CAAC,CAAC;AACH,QAAI,CAAC,SAAS,CAAC,aAAa,EAAC;AAC3B,YAAM,EAAE,CAAC;AACT,UAAI,EAAE,CAAC;AACL,YAAI,EAAE,MAAM,CAAC,OAAO,CAAC,IAAI;AACzB,gBAAQ,EAAE,MAAM,CAAC,QAAQ;OAC1B,CAAC;KACH,CAAC,CAAC;AACH,UAAM,CAAC,aAAa,EAAE,CAAC;GACxB,CAAC;;AAEF,WAAS,WAAW,GACpB;AACE,UAAM,CAAC,YAAY,CAAC,aAAa,EAAC;AAChC,YAAM,EAAE,CAAC;AACT,UAAI,EAAE,CAAC;AACL,YAAI,EAAE,MAAM,CAAC,OAAO,CAAC,IAAI;AACzB,YAAI,EAAE,MAAM,CAAC,QAAQ;AACrB,kBAAU,EAAE,MAAM,CAAC,iBAAiB;AACpC,gBAAQ,EAAE,MAAM,CAAC,QAAQ;AACzB,YAAI,EAAE,MAAM,CAAC,OAAO,CAAC,OAAO;OAC7B,CAAC;KACH,CAAC,CAAC;;AAEH,UAAM,CAAC,OAAO,CAAC,KAAK,CAAC,aAAa,EAAE;AAClC,YAAM,EAAE,CAAC;AACT,UAAI,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,UAAC,WAAW;eAAM;AACvC,cAAI,EAAE,WAAW,CAAC,OAAO,CAAC,IAAI;AAC9B,cAAI,EAAE,WAAW,CAAC,QAAQ;AAC1B,oBAAU,EAAE,WAAW,CAAC,iBAAiB;AACzC,kBAAQ,EAAE,WAAW,CAAC,QAAQ;AAC9B,cAAI,EAAE,WAAW,CAAC,OAAO,CAAC,OAAO;SAClC;OAAC,CAAC;KACJ,CAAC,CAAC;AACH,eAAW,CAAC;aAAM,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,aAAa,EAAC;AACnD,cAAM,EAAC,CAAC;AACR,YAAI,EAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,UAAA,WAAW;iBAAK;AACpC,gBAAI,EAAE,WAAW,CAAC,OAAO,CAAC,IAAI;AAC9B,gBAAI,EAAC,WAAW,CAAC,OAAO,CAAC,OAAO;WACjC;SAAC,CAAC;OACJ,CAAC;KAAA,EAAC,IAAI,CAAC,CAAC;GACV;;AAED,WAAS,YAAY,GACrB;AACE,QAAI,CAAC,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,MAAM,CAAC,QAAQ,GAAG,mBAAmB,CAAC,CAAC;AAC1E,UAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;GAC1B;;AAED,QAAM,CAAC,eAAe,GAAG,YAAM;AAC7B,QAAM,MAAM,GAAC,CAAC,QAAQ,EAAC,MAAM,CAAC,CAAC;AAC/B,WAAO,aAAY,UAAS,OAAO,EAAC;;AAElC,UAAM,QAAQ,GAAC,SAAT,QAAQ,GAAM;AAClB,cAAM,CAAC,GAAG,CAAC,UAAA,KAAK;iBAAI,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,KAAK,EAAC,QAAQ,CAAC;SAAA,CAAC,CAAC;AACnE,eAAO,EAAE,CAAC;OACX,CAAC;AACF,YAAM,CAAC,GAAG,CAAC,UAAA,KAAK;eAAG,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,KAAK,EAAC,QAAQ,CAAC;OAAA,CAAC,CAAC;KACvD,CAAC,CAAC;GACJ,CAAC;;AAGF,QAAM,CAAC,KAAK,GAAG;;;;eAET,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC;;;;;AACxC,gBAAM,CAAC,IAAI,CAAC,2BAA2B,CAAC,CAAC;;;;eAGvC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC;;;;;AACzC,gBAAM,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,CAAC;;;;eAG3D,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,aAAa,CAAC;;;;;AAClD,gBAAM,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,MAAM,CAAC,CAAC;;;;;AAI5E,mBAAS,EAAE,CAAC;;2CACN,MAAM,CAAC,cAAc,EAAE;;;AAC7B,mBAAS,EAAE,CAAC;;2CACN,MAAM,CAAC,OAAO,EAAE;;;AACtB,gBAAM,CAAC,iBAAiB,EAAE,CAAC;AAC3B,gBAAM,CAAC,gBAAgB,EAAE,CAAC;AAC1B,gBAAM,CAAC,YAAY,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;AACnC,gBAAM,CAAC,aAAa,EAAE,CAAC;;AAGvB,oBAAU,EAAE,CAAC;AACb,qBAAW,EAAE,CAAC;AACd,gBAAM,CAAC,cAAc,EAAE,CAAC;;AAExB,sBAAY,EAAE,CAAC;AACf,gBAAM,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;;;2CAEjB,MAAM,CAAC,eAAe,EAAE;;;AAC9B,gBAAM,CAAC,WAAW,EAAE,CAAC;AACrB,2BAAiB,EAAE,CAAC;;;;;;;GACrB,CAAC;CACH,CAAC","file":"lib/plugins/login.js","sourcesContent":["const Vec3 = require(\"vec3\").Vec3;\n\nconst path = require('path');\nconst requireIndex = require('requireindex');\nconst plugins = requireIndex(path.join(__dirname,'..', 'plugins'));\nconst Command = require('flying-squid').Command;\n\nmodule.exports.server=function(serv,options)\n{\n  serv._server.on('connection', client =>\n    client.on('error',error => serv.emit('clientError',client,error)));\n\n  serv._server.on('login', async (client) => {\n    if(client.socket.listeners('end').length==0) return; // TODO: should be fixed properly in nmp instead\n    try {\n      const player = serv.initEntity('player', null, serv.overworld, new Vec3(0,0,0));\n      player._client=client;\n\n      player.profileProperties=player._client.profile ? player._client.profile.properties : [];\n      player.commands = new Command({});\n      Object.keys(plugins)\n        .filter(pluginName => plugins[pluginName].player!=undefined)\n        .forEach(pluginName => plugins[pluginName].player(player, serv, options));\n\n      serv.emit(\"newPlayer\",player);\n      player.emit('asap');\n      await player.login();\n    }\n    catch(err){\n      setTimeout(() => {throw err;},0)\n    }\n  });\n};\n\nmodule.exports.player=function(player,serv,settings)\n{\n  function addPlayer()\n  {\n    player.type = 'player';\n    player.health = 20;\n    player.food = 20;\n    player.crouching = false; // Needs added in prismarine-entity later\n    player.op = settings[\"everybody-op\"]; // REMOVE THIS WHEN OUT OF TESTING\n    player.username=player._client.username;\n    serv.players.push(player);\n    serv.uuidToPlayer[player._client.uuid] = player;\n    player.heldItemSlot=36;\n    player.loadedChunks={};\n  }\n\n  function sendLogin()\n  {\n    // send init data so client will start rendering world\n    player._client.write('login', {\n      entityId: player.id,\n      levelType: 'default',\n      gameMode: player.gameMode,\n      dimension: 0,\n      difficulty: 0,\n      reducedDebugInfo: false,\n      maxPlayers: serv._server.maxPlayers\n    });\n    player.position=player.spawnPoint.toFixedPosition();\n  }\n\n  function sendChunkWhenMove()\n  {\n    player.on(\"move\", () => {\n      if(!player.sendingChunks && player.position.distanceTo(player.lastPositionChunkUpdated)>16*32)\n        player.sendRestMap();\n    });\n  }\n\n  function updateTime()\n  {\n    player._client.write('update_time', {\n      age: [0, 0],\n      time: [0, serv.time]\n    });\n  }\n\n  player.setGameMode = gameMode =>\n  {\n    player.gameMode=gameMode;\n    player._client.write('game_state_change', {\n      reason: 3,\n      gameMode: player.gameMode\n    });\n    serv._writeAll('player_info',{\n      action: 1,\n      data: [{\n        UUID: player._client.uuid,\n        gamemode: player.gameMode\n      }]\n    });\n    player.sendAbilities();\n  };\n\n  function fillTabList()\n  {\n    player._writeOthers('player_info',{\n      action: 0,\n      data: [{\n        UUID: player._client.uuid,\n        name: player.username,\n        properties: player.profileProperties,\n        gamemode: player.gameMode,\n        ping: player._client.latency\n      }]\n    });\n\n    player._client.write('player_info', {\n      action: 0,\n      data: serv.players.map((otherPlayer) => ({\n        UUID: otherPlayer._client.uuid,\n        name: otherPlayer.username,\n        properties: otherPlayer.profileProperties,\n        gamemode: otherPlayer.gameMode,\n        ping: otherPlayer._client.latency\n      }))\n    });\n    setInterval(() => player._client.write('player_info',{\n      action:2,\n      data:serv.players.map(otherPlayer => ({\n        UUID: otherPlayer._client.uuid,\n        ping:otherPlayer._client.latency\n      }))\n    }),5000);\n  }\n\n  function announceJoin()\n  {\n    serv.broadcast(serv.color.yellow + player.username + ' joined the game.');\n    player.emit(\"connected\");\n  }\n\n  player.waitPlayerLogin = () => {\n    const events=[\"flying\",\"look\"];\n    return new Promise(function(resolve){\n\n      const listener=()=> {\n        events.map(event => player._client.removeListener(event,listener));\n        resolve();\n      };\n      events.map(event =>player._client.on(event,listener));\n    });\n  };\n\n\n  player.login = async () =>\n  {\n    if (serv.uuidToPlayer[player._client.uuid]) {\n      player.kick(\"You are already connected\");\n      return;\n    }\n    if (serv.bannedPlayers[player._client.uuid]) {\n      player.kick(serv.bannedPlayers[player._client.uuid].reason);\n      return;\n    }\n    if(serv.bannedIPs[player._client.socket.remoteAddress]){\n        player.kick(serv.bannedIPs[player._client.socket.remoteAddress].reason);\n        return\n    }\n\n    addPlayer();\n    await player.findSpawnPoint();\n    sendLogin();\n    await player.sendMap();\n    player.sendSpawnPosition();\n    player.sendSelfPosition();\n    player.updateHealth(player.health);\n    player.sendAbilities();\n\n\n    updateTime();\n    fillTabList();\n    player.updateAndSpawn();\n\n    announceJoin();\n    player.emit(\"spawned\");\n\n    await player.waitPlayerLogin();\n    player.sendRestMap();\n    sendChunkWhenMove();\n  };\n};"],"sourceRoot":"/source/"}