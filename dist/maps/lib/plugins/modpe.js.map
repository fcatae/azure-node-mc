{"version":3,"sources":["lib/plugins/modpe.js"],"names":[],"mappings":"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","file":"lib/plugins/modpe.js","sourcesContent":["const Vec3 = require(\"vec3\").Vec3;\nconst dir = require(\"node-dir\");\nconst fs = require(\"fs\");\n\nfunction requireFromString(src, filename) {\n  let Module = module.constructor;\n  let m = new Module();\n  m._compile(src, filename);\n  return m.exports;\n}\n\nfunction modpeApi() {\n  let Vec3 = null;\n  let vec3 = null;\n\n  let server = null;\n  let player = null;\n\n  module.exports.startDestroyBlock = startDestroyBlock;\n  module.exports.destroyBlock = destroyBlock;\n  module.exports.newLevel = newLevel;\n  module.exports.procCmd = procCmd;\n  module.exports.exec = exec;\n  module.exports.modTick = modTick;\n  module.exports.useItem = useItem;\n  module.exports.initSquid = initSquid;\n  function modTick(){}\n  function newLevel(){}\n\n  function useItem(x,y,z,itemId,blockId){}\n  function startDestroyBlock(x,y,z,side){}\n  function destroyBlock(x,y,z,side){}\n  function procCmd(command){}\n  function exec(code){eval(code)}\n\n  function initSquid(pl1, srv, v3) {\n    player = pl1;\n    server = srv;\n    vec3=v3;\n    Vec3=v3;\n  }\n\n  function clientMessage(message) {\n    player.chat(message);\n  }\n\n  function setTile(x, y, z, id, damage) {\n    server.setBlock(server.overworld,new Vec3(x, y, z), id, damage);\n  }\n\n  function getTile(x, y, z) {\n    return server._worldSync.getBlockType(new Vec3(x, y, z));\n  }\n\n  function preventDefault() {\n  }\n\n  function getPlayerX() {\n    return player.position.x/32;\n  }\n\n  function getPlayerY() {\n    return player.position.y/32;\n  }\n\n  function getPlayerZ() {\n    return player.position.z/32;\n  }\n\n  function getPlayerEnt() {\n    return null;\n  }\n\n  function getCarriedItem() {\n    return player.heldItem.blockId;\n  }\n\n  let Player = {\n    getCarriedItem: function () {\n      return player.heldItem.blockId;\n    }\n  };\n  let Entity = {\n    getPitch: function () {\n      return 1;\n    }\n    , getYaw: function () {\n      return 1;\n    }\n  };\n  let Level = {\n    getGameMode: function () {\n      return player.gameMode;\n    }\n    , getData: function (x, y, z) {\n      return 0;\n    }\n  };\n}\n\nfunction convert(code) {\n  let api = modpeApi.toString()\n    .split(\"\\n\");\n  api[0] = \"\";\n  api[api.length - 1] = \"\";\n  let finapi = api.join(\"\\n\");\n  code = finapi + code;\n  return code;\n}\n\nmodule.exports.server=function(serv,settings)\n{\n  let verboseMPE=false;\n  function log(msg){\n    if(verboseMPE) serv.log(\"[MPE]:  \"+msg);\n  }\n  if(!settings.modpe){\n    log(\"Modpe support is not enabled, disabling injecting...\");\n    return;\n  }\n  log(\"Modpe injection start...\");\n  let modPePluginsDir = __dirname+\"/../../../modpePlugins\";\n  log(\"Place your scripts in \" + modPePluginsDir);\n  let modCount = 0;\n  let mods = [];\n  dir.readFiles(modPePluginsDir, {\n      match: /.js/\n      , exclude: /^\\./\n    }, function (err, content, fname, next) {\n      if (err) throw err;\n      log(\"Converting \" + fname);\n      content = convert(content);\n      let modname = fname.split(\"/\")[fname.split(\"/\")\n        .length - 1].split(\".\")[0];\n      log(\"Loading mod \" + modname);\n      mods.push(requireFromString(content));\n      modCount++;\n      next();\n    }\n    , function (err, files) {\n      if(err) return;\n      log('Loaded ' + modCount + \" mods\");\n    });\n\n  serv.on(\"newPlayer\", function (player) {\n    injectPlayer(player,serv);\n  });\n\n  function injectPlayer(player,serv) {\n    log(\"Injected into player\");\n\n    initSquid(player, serv, Vec3);\n    newLevel();\n\n    player._client.on(\"block_dig\", function (packet) {\n      let pos = new Vec3(packet.location.x,packet.location.y,packet.location.z);\n      if (packet.status == 0 && player.gameMode != 1)\n        startDestroyBlock(pos.x, pos.y, pos.z, 0);\n      else if (packet.status == 2)\n        destroyBlock(pos.x, pos.y, pos.z, 0);\n      else if (packet.status == 1)\n      {/*Unused in ModPE*/}\n      else if (packet.status == 0 && player.gameMode == 1)\n        destroyBlock(pos.x, pos.y, pos.z, 0);\n    });\n\n    player._client.on('position', function (packet) {\n      modTick();\n    });\n\n    player._client.on(\"block_place\", function (packet) {\n      if (packet.location.y < 0) return;\n      useItem(packet.location.x, packet.location.y, packet.location.z,\n        packet.heldItem.blockId,\n        serv._worldSync.getBlockType(new Vec3(packet.location.x, packet.location.y, packet.location.z)));\n    });\n\n    player.on('modpe', function (command) {\n      try {\n        procCmd(command);\n      }\n      catch(err) {\n        serv.emit(\"error\",err);\n      }\n    });\n\n    function newLevel() {\n      mods.forEach(function (element, index, array) {\n        element.newLevel();\n      });\n    }\n\n    function useItem(x, y, z, itemId, blockId) {\n      mods.forEach(function (element, index, array) {\n        element.useItem(x, y, z, itemId, blockId);\n        element.exec(\"lastUsedItem=\" + itemId);\n      });\n    }\n\n    function modTick() {\n      mods.forEach(function (element, index, array) {\n        element.modTick();\n      });\n    }\n\n    function exec(code) {\n      mods.forEach(function (element, index, array) {\n        element.exec(code);\n      });\n    }\n\n    function procCmd(command) {\n      mods.forEach(function (element, index, array) {\n        element.procCmd(command);\n      });\n    }\n\n    function startDestroyBlock(x, y, z, side) {\n      mods.forEach(function (element, index, array) {\n        element.startDestroyBlock(x, y, z, side);\n      });\n    }\n\n    function destroyBlock(x, y, z, side) {\n      mods.forEach(function (element, index, array) {\n        element.destroyBlock(x, y, z, side);\n      });\n    }\n\n    function initSquid(pl, sr, v3) {\n      mods.forEach(function (element, index, array) {\n        element.initSquid(pl, sr, v3);\n      });\n    }\n  }\n};\n"],"sourceRoot":"/source/"}